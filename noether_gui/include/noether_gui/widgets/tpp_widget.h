#pragma once

#include <noether_tpp/core/types.h>
#include <QMainWindow>
#include <vtkSmartPointer.h>

class QVTKOpenGLNativeWidget;
class QDir;
class vtkActor;
class vtkPolyDataMapper;
class vtkProp;
class vtkRenderer;
class vtkAxes;
class vtkAxesActor;
class vtkTubeFilter;
class vtkAssembly;
class vtkPolyData;

namespace Ui
{
class TPP;
}

namespace noether
{
class ConfigurableTPPPipelineWidget;
class WidgetFactory;

enum class LineStyle
{
  INTRA_SEGMENT = 0, /*@brief between waypoints in a segment*/
  INTER_SEGMENT,     /*@brief between tool path segments*/
  INTER_PATH,        /*@brief between tool paths*/
};

/**
 * @brief Basic tool path planning widget
 * @details Allows the user to laod a mesh from file, configure a tool path planning pipeline, and generate tool paths
 * from the input mesh
 */
class TPPWidget : public QMainWindow
{
public:
  TPPWidget(std::shared_ptr<const WidgetFactory> factory, QWidget* parent = nullptr);

  /**
   * @brief Sets the file path for the mesh to use for tool path planning
   */
  void setMeshFile(const QString& file);

  /**
   * @brief Configures the GUI tool path planning pipeline from a YAML configuration file
   */
  void configure(const QString& file);

  /**
   * @brief Invokes the planning of a tool path based on the current mesh file and tool path planner configuration
   */
  void plan();

  /**
   * @brief Saves the modified meshes created during the planning of a tool path to a directory
   */
  void saveModifiedMeshes(const QDir& save_dir);

  /**
   * @brief Get the planned tool paths
   * @details The highest level vector represents the tool paths generated for each mesh "fragment" generated by the
   * mesh modifier in the tool path planning pipeline
   */
  std::vector<ToolPaths> getToolPaths() const { return tool_paths_; }

  /**
   * @brief Saves the created tool paths to a YAML file
   */
  void saveToolPaths(const QString& file);

  // Visibility controls
  void showOriginalMesh(const bool);
  void showModifiedMesh(const bool);
  void showUnmodifiedToolPath(const bool);
  void showUnmodifiedConnectedPath(const bool);
  void showModifiedToolPath(const bool);
  void showModifiedConnectedPath(const bool);
  void showAxes(const bool);

protected:
  void onLoadMesh(const bool /*checked*/);
  void onSaveModifiedMeshes(const bool /*checked*/);
  void onSaveToolPaths(const bool /*checked*/);
  void render();

  std::string mesh_file_;

  Ui::TPP* ui_;
  ConfigurableTPPPipelineWidget* pipeline_widget_;

  // Viewer rendering
  QVTKOpenGLNativeWidget* render_widget_;
  vtkSmartPointer<vtkRenderer> renderer_;
  vtkSmartPointer<vtkPolyDataMapper> mesh_mapper_;
  vtkSmartPointer<vtkActor> mesh_actor_;

  vtkSmartPointer<vtkAssembly> tool_path_actor_;
  vtkSmartPointer<vtkAssembly> connected_path_actor_;
  vtkSmartPointer<vtkAssembly> unmodified_tool_path_actor_;
  vtkSmartPointer<vtkAssembly> unmodified_connected_path_actor_;
  vtkSmartPointer<vtkAssembly> mesh_fragment_actor_;

  vtkSmartPointer<vtkAxes> axes_;
  vtkSmartPointer<vtkAxesActor> axes_actor_;
  vtkSmartPointer<vtkTubeFilter> tube_filter_;

  std::vector<ToolPaths> tool_paths_;
};

}  // namespace noether
